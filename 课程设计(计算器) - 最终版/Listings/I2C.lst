C51 COMPILER V9.56.0.0   I2C                                                               12/14/2017 18:51:43 PAGE 1   


C51 COMPILER V9.56.0.0, COMPILATION OF MODULE I2C
OBJECT MODULE PLACED IN .\Objects\I2C.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE I2C.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings
                    -\I2C.lst) TABS(2) OBJECT(.\Objects\I2C.obj)

line level    source

   1          #include"I2C.h"
   2          
   3          /***********************************************I2C启动函数***********************************************
             -********/
   4          /*                                            产生总线起始信号                                            
             -       */
   5          /*********************************************************************************************************
             -********/
   6          void I2C_Start()
   7          {
   8   1        I2C_SDA = 1;
   9   1        I2C_SCL = 1;
  10   1        I2CDelay();
  11   1        I2C_SDA = 0;
  12   1        I2CDelay();
  13   1        I2C_SCL = 0;
  14   1      }
  15          
  16          /************************************************I2C停止函数**********************************************
             -********/
  17          /*                                             产生总线停止信号                                           
             -       */
  18          /*********************************************************************************************************
             -********/
  19          void I2C_Stop()
  20          {
  21   1        I2C_SCL = 0;
  22   1        I2C_SDA = 0;
  23   1        I2CDelay();
  24   1        I2C_SCL = 1;
  25   1        I2CDelay();
  26   1        I2C_SDA = 1;
  27   1        I2CDelay();
  28   1      }
  29          
  30          /************************************************I2C总线写操作函数****************************************
             -********/
  31          /*                                      dat：待写入字节  返回从机的应答值                                 
             -       */
  32          /*********************************************************************************************************
             -********/
  33          bit I2C_Write(uchar dat)
  34          {
  35   1        bit ack = 0;
  36   1        uchar mask;
  37   1        for(mask=0x80; mask!=0; mask>>=1)               //将mask按位与dat 从高位到低位依次判断dat每一位的值
  38   1        {
  39   2          if((mask&dat) == 0)                           //若值为0 则拉低SDA 若为1则拉高SDA
  40   2            I2C_SDA = 0;
  41   2          else
  42   2            I2C_SDA = 1;
  43   2          I2CDelay();
  44   2          I2C_SCL = 1;
  45   2          I2CDelay();
C51 COMPILER V9.56.0.0   I2C                                                               12/14/2017 18:51:43 PAGE 2   

  46   2          I2C_SCL = 0;
  47   2        }
  48   1        I2C_SDA = 1;
  49   1        I2CDelay();
  50   1        I2C_SCL = 1;
  51   1        ack = I2C_SDA;
  52   1        I2CDelay();
  53   1        I2C_SCL = 0;
  54   1      
  55   1        return (~ack);
  56   1      }
  57          
  58          /************************************************I2C总线读操作函数****************************************
             -********/
  59          /*                                           发送应答信号 并返回 读到的字节                               
             -       */
  60          /*********************************************************************************************************
             -********/
  61          uchar I2CReadACK()
  62          {
  63   1        uchar mask;
  64   1        uchar dat;
  65   1        I2C_SDA=1;                                  //确保主机释放SDA
  66   1        for(mask=0x80;mask!=0;mask>>=1)
  67   1        {
  68   2          I2CDelay();
  69   2          I2C_SCL=1;                                //拉高SCL
  70   2          if(I2C_SDA==0)
  71   2            dat&=~mask;                             //SDA为0时 dat对应位清零
  72   2          else
  73   2            dat|=mask;
  74   2          I2CDelay();
  75   2          I2C_SCL=0;                                //拉低SCL 使从机发送下一位
  76   2        }
  77   1        I2C_SDA=0;                                  //8位数据发送完后 拉低SDA 发送应答信号
  78   1        I2CDelay();
  79   1        I2C_SCL=1;                                  //拉高SCL
  80   1        I2CDelay();
  81   1        I2C_SCL=0;                                  //再拉低SCL 完成应答位 保持住总线
  82   1        return dat;
  83   1      }
  84          
  85          /************************************************I2C总线读操作函数****************************************
             -********/
  86          /*                                           发送非应答信号 并返回 读到的字节                             
             -       */
  87          /*********************************************************************************************************
             -********/
  88          uchar I2CReadNAK()
  89          {
  90   1        uchar mask;
  91   1        uchar dat;
  92   1        I2C_SDA=1;
  93   1        for(mask=0x80;mask!=0;mask>>=1)
  94   1        {
  95   2          I2CDelay();
  96   2          I2C_SCL=1;
  97   2          if(I2C_SDA==0)
  98   2            dat&=~mask;
  99   2          else
 100   2            dat|=mask;
 101   2          I2CDelay();
C51 COMPILER V9.56.0.0   I2C                                                               12/14/2017 18:51:43 PAGE 3   

 102   2          I2C_SCL=0;
 103   2        }
 104   1        I2C_SDA=1;
 105   1        I2CDelay();
 106   1        I2C_SCL=1;
 107   1        I2CDelay();
 108   1        I2C_SCL=0;
 109   1        return dat;
 110   1      }
 111          
 112          /************************************************I2C寻址函数**********************************************
             -********/
 113          /*                                 检查地址为addr的器件是否存在   返回从器件的应答值                      
             -       */
 114          /*********************************************************************************************************
             -********/
 115          bit I2C_Addresing(uchar addr)
 116          {
 117   1        bit ack = 0;
 118   1        I2C_Start();                                     //产生起始位  启动一次总线操作
 119   1        ack = I2C_Write(addr << 1);                      //器件地址需要左移一位 因为地址是7位 最低位为读写位 
 120   1                                                         //用于表示之后的操作是读还是写
 121   1        I2C_Stop();                                      //不需要进行后续的读写 停止本次总线操作
 122   1        return ack;
 123   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    216    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       2
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
